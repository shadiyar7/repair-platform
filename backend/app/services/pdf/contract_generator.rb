module Pdf
  class ContractGenerator
    include Prawn::View

    def initialize(order)
      @order = order
      @document = Prawn::Document.new(page_size: 'A4', margin: 40)
      
      # Load bundled font for Cyrillic support
      # Load bundled fonts for Cyrillic support (Roboto 2013 version for Prawn compatibility)
      # Load bundled fonts for Cyrillic support (Roboto 2013 version for Prawn compatibility)
      # Note: Using Regular for Bold temporarily to fix missing file 500 error
      font_regular = Rails.root.join('vendor', 'fonts', 'Roboto-Regular.ttf')
      
      begin
        if File.exist?(font_regular)
          size_reg = File.size(font_regular)
          Rails.logger.info "Loading fonts: Regular=#{size_reg}b (Used for Bold too)"
          
          if size_reg > 0
            @document.font_families.update("Roboto" => {
              normal: font_regular.to_s,
              bold: font_regular.to_s,
              italic: font_regular.to_s,
              bold_italic: font_regular.to_s
            })
            @document.font "Roboto"
          else
             Rails.logger.warn "Font file is empty. Fallback to Helvetica."
             @document.font "Helvetica"
          end
        else
          Rails.logger.warn "Font file missing (#{font_regular}). Using Helvetica."
          @document.font "Helvetica"
        end

      rescue => e
        Rails.logger.error "Failed to load Roboto font: #{e.message}. Fallback to Helvetica."
        @document.font "Helvetica"
      end
    end

    def generate
      # Ensure using the custom font if available
      if @document.font_families["Roboto"]
         @document.font "Roboto"
      else
         @document.font "Helvetica"
      end

      # Russian Month Names
      months_ru = {
        1 => 'января', 2 => 'февраля', 3 => 'марта', 4 => 'апреля',
        5 => 'мая', 6 => 'июня', 7 => 'июля', 8 => 'августа',
        9 => 'сентября', 10 => 'октября', 11 => 'ноября', 12 => 'декабря'
      }
      
      current_day = Date.today.strftime('%d')
      current_month = months_ru[Date.today.month]
      current_year = Date.today.year

      # Contract number format: KS-ORDER_ID-YEAR-MONTH
      contract_number = "KS-#{@order.id}-#{current_year}-#{Date.today.strftime('%m')}"
      
      # -----------------------------------------------------------------------
      # HEADER
      # -----------------------------------------------------------------------
      text "Договор поставки № #{contract_number}", size: 14, style: :bold, align: :center
      move_down 20

      # -----------------------------------------------------------------------
      # PREAMBLE
      # -----------------------------------------------------------------------
      buyer_name = (@order.company_requisite&.company_name&.gsub(/\(Main\)/, '')&.strip || @order.user.company_name&.gsub(/\(Main\)/, '')&.strip || '________________________________')
      buyer_director = @order.company_requisite&.director_name || @order.user.director_name || '________________________'
      # Point 1: Director's Authority
      buyer_basis = @order.company_requisite&.acting_on_basis.presence || 'Устава'

      preamble = "Товарищество с ограниченной ответственностью «Komandeer Supply», в лице директора Командирова Адилета Муратовича, действующий на основании Устава, именуемый в дальнейшем «Поставщик», с одной стороны и #{buyer_name}, в лице директора #{buyer_director}, действующего на основании #{buyer_basis}, именуемое в дальнейшем «Покупатель», с другой стороны, а вместе именуемые «Стороны», заключили настоящий договор (далее - Договор) о нижеследующем:"

      text preamble, align: :justify, leading: 2, size: 10
      move_down 15

      # -----------------------------------------------------------------------
      # MAIN SECTIONS
      # -----------------------------------------------------------------------
      
      # Section 1
      text "1. Предмет договора", style: :bold, size: 11
      move_down 5
      text "1.1. По настоящему договору Поставщик обязуется поставить товар в собственность Покупателю, а Покупатель обязуется принять этот товар и уплатить за него установленную цену с НДС.", align: :justify, size: 10
      text "1.2. Наименование, количество, ассортимент, стоимость товара, а также иные характеристики товара (далее - Товар), определяются в спецификации, являющейся неотъемлемой частью настоящего Договора (далее- Спецификация).", align: :justify, size: 10
      # Point 2: Specification Priority
      text "1.3. В случае противоречия условий настоящего Договора и Спецификации приоритет имеют условия Спецификации.", align: :justify, size: 10
      move_down 10

      # Section 2
      text "2. Обязательства Сторон", style: :bold, size: 11
      move_down 5
      text "2.1. Поставщик обязан:", style: :bold, size: 10
      text "2.1.1. Передать Покупателю Товар, предусмотренный настоящим Договором, свободный от прав третьих лиц, надлежащего качества, в количестве и ассортименте, согласованном Сторонами в Спецификации.", align: :justify, size: 10
      text "2.1.2. Одновременно с передачей Товара передать Покупателю его принадлежности, а также относящиеся к нему документы: сертификат качества/паспорт, накладная, ЭСФ, акт приема-передачи.", align: :justify, size: 10
      text "2.1.3. Передать Покупателю Товар в таре и (или) упаковке, обеспечивающей сохранность товаров такого рода при обычных условиях хранения и транспортирования.", align: :justify, size: 10
      text "2.2. Покупатель обязан:", style: :bold, size: 10
      text "2.2.1. Принять переданный ему Товар, за исключением случаев, когда он вправе потребовать замены Товара или отказаться от исполнения Договора купли-продажи.", align: :justify, size: 10
      text "2.2.2. Оплатить Товар по цене и в срок, предусмотренные настоящим Договором.", align: :justify, size: 10
      text "2.2.3. Известить Продавца о нарушении условий договора о количестве, ассортименте, качестве, таре и (или) об упаковке Товара в срок не позднее 3-х рабочих дней после получения Товара.", align: :justify, size: 10
      move_down 10

      # Section 3
      text "3. Цена договора и порядок расчетов", style: :bold, size: 11
      move_down 5
      text "3.1. Цена Договора определяется в Спецификации.", align: :justify, size: 10
      text "3.2. Покупатель должен произвести предоплату Товара в полном объеме в течение 3 (трех) рабочих дней с даты подписания Сторонами настоящего Договора и Спецификации.", align: :justify, size: 10
      text "3.3. Оплата производится путем перечисления денежных средств на банковский счет Продавца, указанный в разделе 10 Договора.", align: :justify, size: 10
      text "3.4. С момента подписания настоящего Договора сумма Договора изменению не подлежит до полного выполнения договорных обязательств обеими Сторонами.", align: :justify, size: 10
      move_down 10

      # Section 4
      text "4. Условия поставки Товара", style: :bold, size: 11
      move_down 5
      text "4.1. Поставщик осуществляет поставку Товара в соответствии с условиями Спецификации к настоящему Договору.", align: :justify, size: 10
      text "4.2. Покупатель принимает поставленный Товар на основании Акта приема-передачи, подписанного уполномоченными представителями обеих Сторон.", align: :justify, size: 10
      move_down 10

      start_new_page

      # Continue Section 4
      text "4.3. При наличии видимых повреждений Товара и/или несоответствия поставленного Товара условиям настоящего Договора и/или Спецификации, Покупатель имеет право отказаться от приемки Товара и от подписания Акта приема-передачи, потребовав от Поставщика замены некачественного Товара на товар надлежащего качества и/или устранения несоответствий характеристик Товара Спецификации.", align: :justify, size: 10
      text "4.4. Риск случайной гибели, порчи, повреждения или утраты Товара переходит к Покупателю после подписания Сторонами Акта приема-передачи.", align: :justify, size: 10
      # Point 5: Updated Defect Acceptance
      text "4.5. Поставщик передает Товар Покупателю для проведения освидетельствования соответствующим депо. В случае признания Товара негодным к эксплуатации Стороны составляют соответствующий акт. Поставщик обязан в течение согласованного Сторонами срока устранить выявленные недостатки либо заменить Товар на товар надлежащего качества. После устранения недостатков Товар повторно предъявляется к приемке и оформляется Актом приема-передачи.", align: :justify, size: 10
      text "4.6. Поставщик гарантирует Покупателю, что товар не заложен, не арестован, свободен от любых обременений и ограничений, не имеет претендентов на право владения, и свободен от каких-либо притязаний третьих лиц.", align: :justify, size: 10
      # Point 6: Updated Quality Clause
      text "4.7. Качество поставляемого Товара должно соответствовать требованиям ГОСТов, ОСТов, ТУ завода-изготовителя, иным обязательным требованиям законодательства Республики Казахстан, а также отраслевым нормативным документам, применимым к данному виду продукции. В случае поставки Товара, бывшего в употреблении, он должен быть пригодным для использования по его назначению с учетом допустимого износа.", align: :justify, size: 10
      text "4.8. Приемка Запчастей по количеству, качеству и комплектации производится в момент их фактической передачи.", align: :justify, size: 10
      # Point 7: Warranty
      text "4.9. Поставщик предоставляет гарантию на Товар сроком 12 (двенадцать) месяцев с даты подписания Акта приема-передачи, если иной срок не установлен Спецификацией.", align: :justify, size: 10
      move_down 10

      # Section 5
      text "5. Ответственность Сторон", style: :bold, size: 11
      move_down 5
      text "5.1. Стороны несут ответственность за неисполнение или ненадлежащее исполнение своих обязательств по настоящему Договору в соответствии с действующим законодательством Республики Казахстан.", align: :justify, size: 10
      text "5.2. Поставщик несет ответственность за сохранность Товара до момента его передачи Покупателю по Акту приема-передачи в соответствии с условиями настоящего Договора.", align: :justify, size: 10
      text "5.3. Поставщик несет ответственность за соответствие Товара параметрам, указанным в Спецификации.", align: :justify, size: 10
      # Point 8: Late Delivery Penalty
      text "5.4. За нарушение сроков поставки Поставщик уплачивает Покупателю неустойку в размере 0,2 % от стоимости непоставленного Товара за каждый день просрочки, но не более 20 % от общей стоимости Товара по Договору.", align: :justify, size: 10
      text "5.5. В случае нарушения сроков оплаты за Товар Покупатель обязан уплатить Поставщику неустойку в размере 0,1 % от стоимости Товара за каждый день просрочки, но не более 10 % от общей стоимости Товара по Договору.", align: :justify, size: 10
      # Point 9: Unilateral Refusal
      text "5.6. В случае просрочки поставки более чем на 15 (пятнадцать) календарных дней Покупатель вправе в одностороннем порядке отказаться от исполнения Договора с требованием возврата уплаченной суммы и начисленной неустойки в течение 5 (пяти) рабочих дней.", align: :justify, size: 10
      text "5.7. В случае непоставки Товара в установленный срок Поставщик обязан возвратить предоплату в течение 5 (пяти) рабочих дней с момента получения письменного требования Покупателя.", align: :justify, size: 10
      move_down 10

      # Section 6
      text "6. Конфиденциальность", style: :bold, size: 11
      move_down 5
      text "6.1. Стороны обязаны сохранять конфиденциальность информации, полученной в ходе исполнения настоящего Договора.", align: :justify, size: 10
      text "6.2. Передача конфиденциальной информации третьим лицам, опубликование или иное разглашение такой информации может осуществляться только с письменного согласия Покупателя, независимо от причины прекращения действия настоящего Договора.", align: :justify, size: 10
      text "6.3. Поставщик не несет ответственности в случае передачи им информации государственным органам, имеющим право ее затребовать в соответствии с законодательством Республики Казахстан, если он предварительно уведомит Покупателя об обращении за информацией соответствующих государственных органов.", align: :justify, size: 10
      move_down 10

      # Section 7
      text "7. Обстоятельства непреодолимой силы", style: :bold, size: 11
      move_down 5
      text "7.1. Ни одна из Сторон не несет ответственности перед другой Стороной за неисполнение или ненадлежащее исполнение обязательств по настоящему Договору, обусловленное действием обстоятельств непреодолимой силы, то есть чрезвычайных и непредотвратимых при данных условиях обстоятельств, в том числе объявленной или фактической войной, гражданскими волнениями, эпидемиями, блокадами, эмбарго, пожарами, землетрясениями, наводнениями и другими природными стихийными бедствиями, а также изданием актов государственных органов.", align: :justify, size: 10
      text "7.2. Свидетельство, выданное соответствующей торгово-промышленной палатой или иным компетентным органом, является достаточным подтверждением наличия и продолжительности действия обстоятельств непреодолимой силы.", align: :justify, size: 10
      text "7.3. Сторона, которая не исполняет свои обязательства вследствие действия обстоятельств непреодолимой силы, должна не позднее чем в трехдневный срок известить другую Сторону о таких обстоятельствах и их влиянии на исполнение обязательств по настоящему Договору.", align: :justify, size: 10
      text "7.4. Если обстоятельства непреодолимой силы действуют на протяжении 3 (Трех) последовательных месяцев, настоящий Договор может быть расторгнут по соглашению Сторон, либо в порядке, установленном пунктом 8.3 настоящего Договора.", align: :justify, size: 10
      move_down 10

      # Section 8
      text "8. Разрешение споров", style: :bold, size: 11
      move_down 5
      text "8.1. Все споры, разногласия и требования, возникающие из настоящего Соглашения или в связи с ним, в том числе связанные с его заключением, изменением, исполнением, нарушением, расторжением, прекращением и действительностью, разрешаются Сторонами в досудебном порядке путем обмена письмами/претензиями, которые соответствующая Сторона обязуется рассмотреть в течение 5 (пять) рабочих дней с даты получения письма/претензии.", align: :justify, size: 10
      text "8.2. В случае невозможности разрешения разногласий путем переговоров споры подлежат рассмотрению в судебном порядке в соответствии с законодательством Республики Казахстан, в компетентном суде по месту нахождению покупателя.", align: :justify, size: 10
      text "8.3. Во всем, что не оговорено настоящим договором, Стороны руководствуются законодательством Республики Казахстан.", align: :justify, size: 10
      move_down 10

      # Section 9
      text "9. Заключительные положения", style: :bold, size: 11
      move_down 5
      text "9.1. Настоящий Договор вступает в силу с момента его подписания обеими Сторонами и действует до полного и надлежащего исполнения обязательств, принятых Сторонами в рамках настоящего Договора.", align: :justify, size: 10
      text "9.2. Любые изменения и дополнения к настоящему Договору считаются действительными только в том случае, если они совершаются в письменной форме, оформлены в виде приложений или дополнительных соглашений к настоящему Договору и подписаны уполномоченными на то представителями Сторон и заверены печатями. Приложения и дополнительные соглашения являются неотъемлемыми частями настоящего Договора.", align: :justify, size: 10
      text "9.3. Документация, направленная по факсу или электронной почте, будет иметь юридическую силу только при условии, что оригинал такой документации будет направлен и получен другой Стороной не позднее 10 (десяти) календарных дней с момента отправления факсимильной (электронной) копии.", align: :justify, size: 10
      text "9.4. После подписания настоящего Договора все предыдущие переговоры и переписка между Сторонами, касающиеся заключения настоящего Договора, противоречащие его условиям, теряют юридическую силу.", align: :justify, size: 10
      text "9.5. Во всем, что не предусмотрено настоящим Договором, Стороны руководствуются нормами законодательства Республики Казахстан.", align: :justify, size: 10
      text "9.6. Настоящий Договор составлен в 2 (двух) экземплярах, имеющих равную юридическую силу, по одному для каждой из Сторон.", align: :justify, size: 10
      # Point 12: Digital Signature
      text "9.7. Стороны признают юридическую силу документов, подписанных посредством электронной цифровой подписи (ЭЦП) в соответствии с законодательством Республики Казахстан.", align: :justify, size: 10
      move_down 10

      start_new_page

      # -----------------------------------------------------------------------
      # SECTION 10: REQUISITES AND SIGNATURES
      # -----------------------------------------------------------------------
      text "10. Реквизиты и подписи Сторон", style: :bold, size: 12, align: :center
      move_down 15

      y_position = cursor
      bounding_box([0, y_position], width: 260) do
        text "ПОСТАВЩИК", style: :bold, size: 10
        move_down 5
        text "Наименование: ТОО «Komandeer Supply»", size: 9
        text "Юридический адрес: Казахстан, город Астана, район Нұра, Проспект Тұран, здание 46/2, офис 613, почтовый индекс 010000", size: 8, align: :justify
        text "Фактический адрес: Казахстан, город Астана, район Есиль, Конаева 10, БЦ «Emerald Tower», офис 501, почтовый индекс 010017", size: 8, align: :justify
        text "БИН: 100740004791", size: 9
        text "IBAN (KZT): KZ5396503F0012694785", size: 9
        text "Банк: Филиал АО \"ForteBank\" в г. Астана", size: 9
        text "SWIFT: IRTYKZKA", size: 9
        text "БИН Банка: 990841000632", size: 9
        text "Тел: +7 701 006 45 48", size: 9
        text "Email: komandeer@internet.ru", size: 9
        move_down 15
        text "Директор", size: 9
        text "_____________ Командиров А.М.", size: 9
        text "М.П.", size: 9
      end

      bounding_box([280, y_position], width: 260) do
        req = @order.company_requisite
        text "ПОКУПАТЕЛЬ", style: :bold, size: 10
        move_down 5
        text "Наименование: #{req&.company_name || @order.user.company_name || '________________'}", size: 9
        text "БИН: #{req&.bin || @order.user.bin || '________________'}", size: 9
        text "Юр. адрес: #{req&.legal_address || @order.user.legal_address || '________________'}", size: 8, align: :justify
        text "Факт. адрес: #{req&.actual_address || req&.legal_address || '________________'}", size: 8, align: :justify
        text "IBAN: #{req&.iban || '________________'}", size: 9
        text "Банк: #{req&.bank_name || '________________'}", size: 9
        if req&.swift.present?
          text "SWIFT: #{req.swift}", size: 9
        end
        move_down 15
        text "Директор", size: 9
        text "_____________ #{req&.director_name || '________________'}", size: 9
        text "М.П.", size: 9
      end

      start_new_page

      # -----------------------------------------------------------------------
      # APPENDIX 1: SPECIFICATION
      # -----------------------------------------------------------------------
      
      # Point 11: Localized Date
      text "Приложение №1", align: :right, size: 10
      text "к Договору поставки № #{contract_number}", align: :right, size: 10
      text "от «#{current_day}» #{current_month} #{current_year} г.", align: :right, size: 10
      move_down 10
      text "Спецификация №1", style: :bold, align: :center, size: 14
      move_down 10
      text "г. Астана                                                                                                          «#{current_day}» #{current_month} #{current_year} г.", align: :center, size: 10
      move_down 15

      spec_preamble = "#{buyer_name}, именуемое в дальнейшем «Покупатель», в лице директора #{buyer_director}, действующей на основании #{buyer_basis}, с одной стороны, и ТОО «Komandeer Supply» именуемое в дальнейшем «Поставщик», в лице Директора Командирова А.М., действующего на основании Устава, с другой стороны, далее совместно именуемые «Стороны», настоящим удостоверяем, что Сторонами достигнуто соглашение о цене, количестве и иных условиях поставки Товара, являющегося предметом Договора поставки № #{contract_number} от «#{current_day}» #{current_month} #{current_year} г."
      
      text spec_preamble, align: :justify, size: 10
      move_down 10

      text "Поставщик по настоящей Спецификации поставляет следующие Товары и Услугу:", size: 10
      move_down 10

      # Build items table
      items = @order.order_items.map.with_index(1) do |item, index|
        product_price = item.product&.price || 0
        current_price = item.price.to_f
        effective_price = current_price > 0 ? current_price : product_price
        
        Rails.logger.info "PDF Gen [Item ##{item.id}]: DB Price=#{item.price.inspect}, Product Price=#{product_price}, Effective=#{effective_price}"

        [
          index.to_s,
          item.product&.name,
          "шт.",
          item.quantity.to_s,
          ActionController::Base.helpers.number_to_currency(effective_price, unit: "", separator: ",", delimiter: " ", precision: 2).strip,
          ActionController::Base.helpers.number_to_currency(item.quantity * effective_price, unit: "", separator: ",", delimiter: " ", precision: 2).strip
        ]
      end

      items_data = [["№", "Наименование", "Ед. изм.", "Кол-во", "Цена (тг)", "Сумма (тг)"]] + items
      
      table(items_data, header: true, width: 520) do
        row(0).style(font_style: :bold, background_color: "EEEEEE", align: :center, size: 9)
        cells.borders = [:bottom, :top, :left, :right]
        cells.padding = 4
        cells.size = 9
        column(0).width = 30
        column(2).width = 50
        column(3).width = 50
      end

      move_down 10
      total_sum = @order.total_amount
      text "Общая сумма спецификации: #{ActionController::Base.helpers.number_to_currency(total_sum, unit: "тенге", separator: ",", delimiter: " ", format: "%n %u")}, с НДС.", style: :bold, size: 10
      move_down 15
      
      # Point 3: Prepayment Terms Collision (3 days instead of 1)
      text "2. Покупатель в течение 3 (трех) рабочих дней со дня подписания настоящей Спецификации производит предоплату в размере 100 % (сто) от общего объема поставки.", align: :justify, size: 10
      
      # Point 4: Third Party Claims
      text "3. Поставщик гарантирует, что поставляемый Товар свободен от любых прав и притязаний третьих лиц, т.е. никому не продан, не заложен, в споре и под запрещением (арестом) не состоит. В случае предъявления третьими лицами требований к Покупателю, связанных с правами на поставленный Товар, Поставщик обязуется самостоятельно и за свой счет урегулировать такие требования, а также возместить Покупателю все причиненные убытки, включая судебные расходы.", align: :justify, size: 10
      
      text "4. Транспортные расходы и доставка Товара осуществляется силами и за счет Поставщика.", align: :justify, size: 10
      text "5. Срок поставки Товара: 7 рабочих дней после получения 100% предоплаты.", align: :justify, size: 10
      text "6. Настоящая Спецификация вступает в силу со дня подписания и является неотъемлемой частью Договора.", align: :justify, size: 10
      text "7. Настоящая Спецификация составлена в 2-х экземплярах, имеющих равную юридическую силу, по одному для каждой из сторон.", align: :justify, size: 10
      
      move_down 25

      # Specification signatures
      y_pos_spec = cursor
      bounding_box([0, y_pos_spec], width: 250) do
        text "ПОСТАВЩИК", style: :bold, size: 10
        text "ТОО «Komandeer Supply»", size: 9
        move_down 20
        text "Директор _____________ Командиров А.М.", size: 9
        text "М.П.", size: 9
      end

      bounding_box([300, y_pos_spec], width: 250) do
        text "ПОКУПАТЕЛЬ", style: :bold, size: 10
        text buyer_name, size: 9
        move_down 20
        text "Директор _____________ #{buyer_director}", size: 9
        text "М.П.", size: 9
      end

      render
    end
  end
end
